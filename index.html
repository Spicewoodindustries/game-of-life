```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>LevelUp Quest ‚Äì v3.0 (Living World ‚Ä¢ EGA)</title>
<style>
:root{
  /* EGA-style palette */
  --bg:#001a66;        /* deep blue */
  --panel:#0b2a7a;     /* mid blue */
  --fg:#55ffff;        /* bright cyan text */
  --accent:#ffff55;    /* yellow accent */
  --mag:#ff55ff;       /* magenta accent */
  --warn:#ff5555;
}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:"Courier New",monospace}
.wrap{max-width:1060px;margin:0 auto;padding:20px}
h1,h2{margin:0 0 10px;text-shadow:0 0 6px var(--fg)}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
.card{border:1px solid var(--fg);background:linear-gradient(180deg,var(--panel),#062063);padding:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.pill{border:1px solid var(--fg);padding:3px 8px}
.small{font-size:.92em}
button{background:#061a55;color:var(--fg);border:1px solid var(--fg);padding:6px 10px;margin:4px 6px 0 0;cursor:pointer}
button:hover{background:var(--fg);color:#001b55}
input[type="text"],input[type="number"]{background:#001043;border:1px solid var(--fg);color:var(--fg);padding:4px 6px;min-width:0}
.progress{background:#001043;border:1px solid var(--fg);height:16px;width:100%;margin:6px 0 0}
.progress-inner{background:var(--accent);height:100%;width:0%;transition:width .4s ease}
.meta{opacity:.9}
.err{color:var(--warn)}
/* Quest flow */
.task{margin:6px 0}
.section-title{margin-top:10px;border-top:1px dashed var(--fg);padding-top:8px}
.fade-out{animation:out .28s ease forwards}
@keyframes out{to{opacity:0;transform:translateX(12px)}}
/* Level-up celebration */
.levelup-banner{display:none;margin-top:8px;border:1px solid var(--fg);padding:8px;text-align:center;background:#001043}
.lvl-show{display:block;animation:flash .9s ease-out}
@keyframes flash{0%{box-shadow:0 0 0px var(--accent)}50%{box-shadow:0 0 18px var(--accent)}100%{box-shadow:0 0 0px var(--accent)}}
.flash-once{animation:btnflash .28s ease-out}
@keyframes btnflash{0%{box-shadow:0 0 0px var(--mag)}50%{box-shadow:0 0 14px var(--mag)}100%{box-shadow:0 0 0px var(--mag)}}
/* Avatar area */
.avatar-wrap{display:flex;gap:12px;align-items:center}
canvas#avatar{background:#000c2e;border:1px solid var(--fg)}
/* Inline edit controls */
.inline-controls{display:flex;gap:6px;align-items:center;margin-top:6px}
.editing{background:#071e60;padding:6px}
ul.compact{margin:6px 0 0 16px;padding:0}
ul.compact li{margin:2px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1>LEVELUP QUEST ‚Äî v3.0</h1>
    <a class="pill right" href="daily_log.html">üìò Daily Log</a>
    <span class="pill">üîï Sound: <span id="soundState">Muted</span></span>
    <button id="toggleSoundBtn">Toggle Sound</button>
  </div>

  <div class="grid">
    <!-- Player / Avatar -->
    <div class="card" id="statsCard">
      <h2>Player</h2>
      <div class="avatar-wrap">
        <canvas id="avatar" width="64" height="64" title="Your avatar evolves each level"></canvas>
        <div>
          <p>Level <span id="level">1</span> | XP <span id="xp">0</span>/<span id="xpNeeded">100</span> | GP üí∞ <span id="gold">0</span></p>
          <div class="progress"><div id="xpBar" class="progress-inner"></div></div>
          <div id="levelUpBanner" class="levelup-banner">‚ú® LEVEL UP! ‚ú®</div>
        </div>
      </div>

      <h2 class="section-title">Streaks</h2>
      <p class="meta">üî• Current Streak: <strong><span id="streak">0</span> days</strong></p>
      <p class="meta">üèÜ Longest Streak: <strong><span id="longestStreak">0</span> days</strong></p>
      <p class="meta">üìÖ Today: <span id="todayLabel">‚Äî</span></p>
      <p class="meta">üïõ Last Rollover: <span id="lastRollover">‚Äî</span></p>
      <div class="row">
        <button id="forceRolloverBtn" title="Simulate new day">Force New Day</button>
        <button id="resetBtn" title="Manual reset">Reset for New Day</button>
      </div>

      <h2 class="section-title">Player Stats</h2>
      <p>Total XP Earned: <strong><span id="statTotalXp">0</span></strong></p>
      <p>Total GP Earned: <strong><span id="statTotalGp">0</span></strong></p>
      <p>Total Quests Completed: <strong><span id="statTotalQuests">0</span></strong></p>
      <p>Rewards Purchased: <strong><span id="statRewardsBought">0</span></strong></p>
    </div>

    <!-- Quests -->
    <div class="card" id="questsCard">
      <h2>Active Quests</h2>
      <div id="tasks"></div>
      <div class="inline-controls small" style="margin-top:8px">
        <input id="newQuestName" type="text" placeholder="Quest name">
        <input id="newQuestXp" type="number" placeholder="XP" min="1" step="1" style="width:90px">
        <input id="newQuestGp" type="number" placeholder="GP" min="0" step="1" style="width:90px">
        <button id="addQuestBtn">Add Goal</button>
      </div>
      <p class="meta">Tip: complete <em>all</em> active quests before rollover to extend your streak.</p>
      <div id="questMsg" class="meta"></div>

      <h2 class="section-title">Completed Today</h2>
      <div id="doneToday"></div>
    </div>

    <!-- Shop -->
    <div class="card">
      <h2>Reward Shop</h2>
      <div id="shopList"></div>
      <div class="inline-controls small" style="margin-top:8px">
        <input id="newRewardName" type="text" placeholder="Reward name">
        <input id="newRewardCost" type="number" placeholder="Cost (GP)" min="1" step="1" style="width:120px">
        <button id="addRewardBtn">Add Reward</button>
      </div>
      <div id="shopMsg" class="meta"></div>
      <h3 class="section-title">Purchases</h3>
      <ul id="purchaseLog" class="compact"></ul>
    </div>
  </div>
</div>

<script>

/* ---------- Core setup ---------- */
const STORAGE_KEY = "levelupQuest_v30";
const baseXpNeeded = 100;

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}
function timeLabel(d = new Date()) {
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

/* Sound (muted by default) */
let audioCtx = null;
let soundMuted = true;
function ensureAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function beep(f = 880, d = 0.1, t = "square", g = 0.05) {
  if (soundMuted) return;
  ensureAudioCtx();
  const o = audioCtx.createOscillator(),
    ga = audioCtx.createGain();
  o.type = t;
  o.frequency.value = f;
  ga.gain.value = g;
  o.connect(ga);
  ga.connect(audioCtx.destination);
  o.start();
  setTimeout(() => o.stop(), d * 1000);
}
function levelUpSound() {
  beep(523.25, 0.08, "square", 0.06);
  setTimeout(() => beep(659.25, 0.08, "square", 0.06), 90);
  setTimeout(() => beep(783.99, 0.12, "square", 0.06), 180);
}

/* Default player template */
let player = {
  level: 1,
  xp: 0,
  gold: 0,
  quests: [
    { name: "Morning Routine", xp: 10, gp: 5, done: false },
    { name: "Workout", xp: 20, gp: 10, done: false },
    { name: "Read 20 mins", xp: 15, gp: 7, done: false },
    { name: "Healthy Meal", xp: 10, gp: 5, done: false },
    { name: "Reflect/Journaling", xp: 20, gp: 10, done: false },
  ],
  meta: {
    lastDate: null,
    lastRolloverAt: null,
    streak: 0,
    longestStreak: 0,
    totalXpEarned: 0,
    totalGpEarned: 0,
    totalQuestsCompleted: 0,
    rewardsBought: 0,
    todayXp: 0,
    todayGp: 0,
  },
  shop: {
    items: [
      { id: "snack", label: "Small Treat", cost: 30 },
      { id: "movie", label: "Movie Night", cost: 60 },
      { id: "dayoff", label: "Day Off", cost: 120 },
    ],
    purchases: [],
  },
  dailyLog: [],
  settings: { soundMuted: true },
};

/* Persistence */
function saveGame() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(player));
}
function loadGame() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const p = JSON.parse(raw);
    player = Object.assign({}, player, p);
    player.meta = Object.assign({}, player.meta, p.meta || {});
    player.shop = Object.assign({}, player.shop, p.shop || {});
    player.settings = Object.assign({}, player.settings, p.settings || {});
    if (p.quests) player.quests = p.quests;
    if (Array.isArray(p.dailyLog)) player.dailyLog = p.dailyLog;
  } catch (e) {
    console.warn("Save corrupted; defaults used.", e);
  }
}

/* Math & UI helpers */
function xpNeededFor(l) {
  return baseXpNeeded * Math.pow(1.2, l - 1);
}
function setMsg(el, txt, err = false) {
  el.textContent = txt || "";
  el.classList.toggle("err", !!err);
}
function flashButton(btn) {
  if (!btn) return;
  btn.classList.remove("flash-once");
  void btn.offsetWidth;
  btn.classList.add("flash-once");
}
function showLevelUpBanner() {
  const el = document.getElementById("levelUpBanner");
  el.classList.remove("lvl-show");
  void el.offsetWidth;
  el.classList.add("lvl-show");
  levelUpSound();
  sparkAvatar();
  setTimeout(() => el.classList.remove("lvl-show"), 1200);
}

/* Avatar rendering */
const avatarCanvas = document.getElementById("avatar"),
  actx = avatarCanvas.getContext("2d");
function drawAvatar() {
  const lvl = Math.max(1, Math.min(5, player.level));
  const img = new Image();
  img.src = `assets/avatar_${lvl}.png`;
  img.onload = () => {
    actx.clearRect(0, 0, 64, 64);
    actx.drawImage(img, 0, 0, 64, 64);
  };
  img.onerror = () => {
    actx.clearRect(0, 0, 64, 64);
    actx.fillStyle = "#002b99";
    actx.fillRect(0, 0, 64, 64);
    actx.fillStyle = "#55ffff";
    actx.fillRect(12, 16, 40, 40);
    actx.fillStyle = "#001a66";
    actx.fillRect(20, 24, 24, 24);
  };
}

/* Spark effect */
function sparkAvatar() {
  const N = 24,
    parts = [];
  for (let i = 0; i < N; i++) {
    parts.push({
      x: 32,
      y: 32,
      r: 1 + Math.random() * 2,
      dx: (Math.random() * 2 - 1) * 2,
      dy: (Math.random() * 2 - 1) * 2,
      life: 20 + Math.random() * 15,
    });
  }
  let t = 0;
  const raf = () => {
    t++;
    actx.save();
    actx.globalCompositeOperation = "lighter";
    parts.forEach((p) => {
      p.x += p.dx;
      p.y += p.dy;
      p.dy += 0.05;
      p.life--;
      actx.fillStyle = `rgba(255,255,85,${Math.max(0, p.life / 30)})`;
      actx.beginPath();
      actx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      actx.fill();
    });
    actx.restore();
    if (t < 28) requestAnimationFrame(raf);
    else drawAvatar();
  };
  requestAnimationFrame(raf);
}

/* Rollover + daily log */
function needsRollover() {
  return player.meta.lastDate && player.meta.lastDate !== todayStr();
}
function writeDailyLog() {
  const completed = player.quests.filter((q) => q.done).map((q) => q.name);
  const entry = {
    date: player.meta.lastDate || todayStr(),
    completed,
    xp: player.meta.todayXp || 0,
    gp: player.meta.todayGp || 0,
  };
  if (completed.length || entry.xp || entry.gp) player.dailyLog.push(entry);
  player.meta.todayXp = 0;
  player.meta.todayGp = 0;
}
function performRollover() {
  writeDailyLog();
  const allDone = player.quests.every((q) => q.done);
  player.meta.streak = allDone ? player.meta.streak + 1 : 0;
  if (player.meta.streak > player.meta.longestStreak)
    player.meta.longestStreak = player.meta.streak;
  player.quests.forEach((q) => (q.done = false));
  document.getElementById("doneToday").innerHTML = "";
  player.meta.lastDate = todayStr();
  player.meta.lastRolloverAt = timeLabel();
  saveGame();
}
function ensureDailyRolloverOnLoad() {
  if (!player.meta.lastDate) {
    player.meta.lastDate = todayStr();
    player.meta.lastRolloverAt = timeLabel();
    saveGame();
    return;
  }
  if (needsRollover()) performRollover();
}
setInterval(() => {
  if (needsRollover()) {
    performRollover();
    updateUI();
    renderAll();
  }
}, 60000);

/* --- Rendering + Boot Delay --- */
function renderAll() {
  document.getElementById("doneToday").innerHTML = "";
  renderQuests();
  renderShop();
  updateUI();
}

document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    console.log("‚öôÔ∏è Safe Booting v3.0...");
    loadGame();
    ensureDailyRolloverOnLoad();
    soundMuted = !!player.settings.soundMuted;
    renderAll();
    console.log("‚úÖ Safe Boot complete.");
  }, 120);
});


